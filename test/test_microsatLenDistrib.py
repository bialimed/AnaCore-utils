#!/usr/bin/env python3

__author__ = 'Frederic Escudie'
__copyright__ = 'Copyright (C) 2022 CHU Toulouse'
__license__ = 'GNU General Public License'
__version__ = '1.0.0'
__email__ = 'escudie.frederic@iuct-oncopole.fr'
__status__ = 'prod'

from anacore.region import Region
import os
import pysam
import sys
import tempfile
import unittest
import uuid

TEST_DIR = os.path.dirname(os.path.abspath(__file__))
APP_DIR = os.path.dirname(TEST_DIR)
BIN_DIR = os.path.join(APP_DIR, "bin")
sys.path.append(BIN_DIR)

from microsatLenDistrib import getMicrosatLengths, getMicrosatStitchedLengths


########################################################################
#
# FUNCTIONS
#
########################################################################
def samToBam(in_sam, out_bam):
    with pysam.AlignmentFile(in_sam, "r") as reader:
        with pysam.AlignmentFile(out_bam, "wb", header=reader.header) as writer:
            for record in reader:
                writer.write(record)


class TestAnnotBND(unittest.TestCase):
    def setUp(self):
        tmp_folder = tempfile.gettempdir()
        unique_id = str(uuid.uuid1())
        self.tmp_aln = os.path.join(tmp_folder, unique_id + "_aln.bam")
        self.tmp_sam = os.path.join(tmp_folder, unique_id + "_aln.sam")
        with open(self.tmp_sam, "w") as writer:
            writer.write("""@HD	VN:1.6	SO:coordinate
@SQ	SN:4	LN:190214555
NDX550421_RUO:225:HFJ7VBGXL:1:23307:24146:16830	99	4	54731906	60	149M	=	54732024	185	ATGGAGGATGACGAGTTGGCCCTAGACTTAGAAGACTTGCTGAGCTTTTCTTACCAGGTGGCAAAGGGCATGGCTTTCCTCGCCTCCAAGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTT	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEAEEEEEEEEE<EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEE/	NM:i:0	MD:Z:149	AS:i:149	XS:i:0
NDX550421_RUO:225:HFJ7VBGXL:1:12102:21903:12589	163	4	54731928	60	143M6S	=	54731986	206	TAGACTTAGAAGACTTGCTGAGCTTTTCTTACCAGGTGGCAAAGGGCATGGCTTTCCTCGCCTCCAAGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTTGATAA	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEAAAAAAAEAAAAEEEEEEEAAAA6////E	NM:i:0	MD:Z:143	AS:i:143	XS:i:36
NDX550421_RUO:225:HFJ7VBGXL:4:11402:10720:7875	163	4	54731952	60	94M1D55M	=	54731984	182	TTTCTTACCAGGTGGCAAAGGGCATGGCTTTCCTCGCCTCCAAGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTCTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATATTTAAA	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEE///AA////A<<AEA<////<<A6//A/AEA	NM:i:3	MD:Z:94^T6T42G5	AS:i:132	XS:i:33
NDX550421_RUO:225:HFJ7VBGXL:2:23304:2483:14084	163	4	54731957	60	89M1I59M	=	54732046	205	TACCAGGTGGCAAAGGGCATGGCTTTCCTCGCCTCCAAGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTTGTGAACAGAGCATTTTAGGGCAATATTTAAAATG	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE////////////AEE///////////A/<A/<//	NM:i:5	MD:Z:115A16A2C3G8	AS:i:121	XS:i:36
NDX550421_RUO:225:HFJ7VBGXL:4:11402:10720:7875	83	4	54731984	60	62M1D87M	=	54731952	-182	CTCGCCCCCAATAATGTAAGTGGGAGTGATTCTCTAAAGATTTTTGTGTTTTGTTTTTTTGATTTTTTCTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCA	//</<E/AA<A///////////EE//////A////EEA////E<E6////E</6EEAEEE///EEEEE/6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:5	MD:Z:6T4G28G21^T6T80	AS:i:122	XS:i:33
NDX550421_RUO:225:HFJ7VBGXL:1:12102:21903:12589	83	4	54731986	60	60M1I88M	=	54731928	-206	CGCCTCCAATAATTTAAGTGGGAGTGATTCTCTAAATAGTTTTGTGTTTTTTTTTTTTTATTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCA	6/AA//<AE//<////////<A///////////<EE////EEE///AEEE/EEEEEEE//AEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:6	MD:Z:9G3G22G13G7G89	AS:i:116	XS:i:40
NDX550421_RUO:225:HFJ7VBGXL:3:21605:17256:9505	99	4	54731988	60	80M69S	=	54731988	87	CCTCCAAGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTGAGAGTTTTACTCTGTTGCCCTAGATCGGAAGAGCACACGTGTGAACTCCATGCACAATGACGGGGAGG	AAAAAEEEEEEEEEAEEEEEEEEEEEEEEEEEE6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE/////E/////////E/AAE//////////<///A////</////////<//////<A////E//<///	NM:i:0	MD:Z:80	AS:i:80	XS:i:33	SA:Z:14,103047258,-,47S42M60S,19,1;
NDX550421_RUO:225:HFJ7VBGXL:3:21605:17256:9505	147	4	54731988	8	47S55M3D29M18S	=	54731988	-87	ACACGGTTGAGTCCACCCCCTTTCCCAACCCGACCCGCTTCCCCTCTCCTCCAACAATGTAAGTGGGTGTGTTTCTCTAAAGCGTTTTGTTTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAGTATTACTCTGTTGCCCT	<///<////////////////<//////////////////////////E//A////E/////////////////////A</////EEE///66EE/AEEEEEE/6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:8	MD:Z:7G12A3A10A7G11^TGA29	AS:i:50	XS:i:43
NDX550421_RUO:225:HFJ7VBGXL:1:21301:7377:3373	163	4	54731993	60	53M3D96M	=	54732058	214	AAGAATATAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTGTGAACAGAGCATTTTAGGGCCATATTTAAAATGCAGAATGTAATTTTGAAGTGTGGTAACCAAAAGCAGGGGA	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEE//A////////AEEEA/////<////E</AE/A////E//<///EEEE//E<A6/<AA//A/<EE//////A/<	NM:i:9	MD:Z:6G46^TTT23A16A6G16C27A3	AS:i:111	XS:i:32
NDX550421_RUO:225:HFJ7VBGXL:2:11309:6024:2321	99	4	54731993	60	53M2D65M31S	=	54732012	120	AAGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTGAGAACAAAGAATTTTTGAGCCATATTTAAAATGCAGAATGTAGATCGGAAGAGCACACGTCGGAACGCCAGG	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE/A//<////////EEEA////E/E///E</EE///<//A<//</////AA<E///A///AA////</</AA/</	NM:i:6	MD:Z:53^TT30G2C5A8G16	AS:i:90	XS:i:34
NDX550421_RUO:225:HFJ7VBGXL:2:11211:2514:5427	163	4	54731994	60	78M71S	=	54732031	98	AGAATGTAAGTGGGAGTGATTCTCTAAAGAGTTATGTGTTTTGTTTTTTTGATTTTTTTAATTTTTTTTTTTTTTTTGGGAACCTGGGTTTTTTGCAGCTCGGAAGAGCGGCGGGGGGTGGGAGAATGTTGGGCCAGAAGGGGTTAGGA	AAAAAEAEEEEE//AEEEEEEA///EEEEE6E//EE/EEEEEEEEEA/EAAAAA/EA/A//A///<AEAEE/E//E<////////<////////////////////////A/////////////A////////6///////////////	NM:i:3	MD:Z:33T25T0T17	AS:i:63	XS:i:28
NDX550421_RUO:225:HFJ7VBGXL:2:11204:19792:17814	99	4	54731996	60	50M1D99M	=	54732080	233	AATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATATTTAAAATGCAGAATTTAATTTTTAATTGTGGTAACCAAAAGCAGGGGAA	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE////////////EEE<//////////EA/EE////////A////AEEE/////////6//6/AEE//////<//A	NM:i:7	MD:Z:50^T49G14G1C5G2G18A4	AS:i:112	XS:i:37
NDX550421_RUO:225:HFJ7VBGXL:3:22607:13119:7977	99	4	54731996	60	149M	=	54732025	165	AATGTAAGTGGGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTTGAGCCATTTTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGGGGA	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE6/////A/////AEEE////E/AA//<E<EA/A//////<////EEEE/A//////<EE//<AEE/A//</A6/	NM:i:4	MD:Z:91A7A0G44A3	AS:i:130	XS:i:38
NDX550421_RUO:225:HFJ7VBGXL:3:12407:20315:16927	147	4	54732002	48	57S34M1D58M	=	54731885	-210	GGGTTCCTTTCTTACCAGGGGGCAAACGGCCAGGGTTTCCCCGCCCCCAATTATTTTAGTGGGAGTTTTTCTCTAAACAGTTTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCAT	////////EE/////A/////EA//6//<////<//////////E//A/<///////////A<//////A////AEE////A<A///66EE/6EEEEEE//6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:7	MD:Z:9G0A9G6G6^G7G0A49	AS:i:55	XS:i:49
NDX550421_RUO:225:HFJ7VBGXL:2:13212:2679:7162	163	4	54732006	60	65M84S	=	54732030	74	GGAGTGATTCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTTCGAACGTAATTCAGGAAGTGCGTGGTGTAGGGATGGTTTGTATTCAGGCAGGGGTTAAGAGCGGGGGGGCCGGTAAAATTTAA	AAAAAEAEEEEEA/E6EAEA<EE/EE/AEE6EEEEE<EEEA/EEEEEEAEEEEEEE6EE/EE/E/////////A///////////////////////A//////////////////////////////////66////6/////////A	NM:i:0	MD:Z:65	AS:i:65	XS:i:36
NDX550421_RUO:225:HFJ7VBGXL:2:11309:6024:2321	147	4	54732012	60	50S33M2D66M	=	54731993	-120	CCCCTCTCCCCACCCCACCCTCTTCCCTCCAAATTATGTAAGGGGGATTTATTCTCTAAATAGTTTTTTGTTTTGTTTTTTTGTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGT	////////////////////////////////////////////</////////////<//////E/////AEE//6EEEEE/6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEAAAAA	NM:i:4	MD:Z:10G6G15^AT66	AS:i:81	XS:i:39
NDX550421_RUO:225:HFJ7VBGXL:4:13605:22833:2018	99	4	54732014	60	136M13S	=	54732049	184	TCTCTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTGAGAAAAGGGCATTTTTGAGCCATATTTAAATTGCAGAATGTAATTTTTAAGTGTGGTAACCAAAAGCAGGGGAAATTTTTTTTATTAATTT	AAAAAEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE6///////////EEEE//////66//E</AE/A//////A<///EEEE////</AE//<A</AE////////////AEA//EE6/AE/<E/A	NM:i:8	MD:Z:62C2A7A8G5A10C5G21A8	AS:i:96	XS:i:38
NDX550421_RUO:225:HFJ7VBGXL:3:11605:14639:5896	163	4	54732017	60	149M	=	54732031	163	CTAAAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGCGCCATAGTTAAAATGCAGAATGTCATTTTTAAGTGTGGTAACCAAAACCAGGGGAAATTTAGTTTATTCATGTTCC	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE/EEEEEEEEEEEEEA///A<6//////EEEEA///EAE///E<<EEA/////E/E////AEEE/A//EA/A/</AEAEEE///A//E/EE/6<<//EE//<///A/E/E6	NM:i:5	MD:Z:72A29G17G3A13C10	AS:i:124	XS:i:38
NDX550421_RUO:225:HFJ7VBGXL:4:12412:19001:1641	163	4	54732020	60	26M1I95M27S	=	54732096	225	AAGAGTTTTGTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTTTAGAACAGAGCATTTTAGAGCAATTTTTAAAATGCAGAATGTAATTTTGAAGTGTGGTAACAAAAAGCAGGGGAATTTTTTTTTGTTGTTGTTCAAA	/AAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE//////////////AA/////////////////////////////<EEA///////<////////////////////<<////A//A/////</////	NM:i:7	MD:Z:51G20C2A0G16C18C8	AS:i:84	XS:i:37
NDX550421_RUO:225:HFJ7VBGXL:1:23307:24146:16830	147	4	54732024	40	83S12M1D54M	=	54731906	-185	CCTGCGGCGCGTTTCTTACCAGGGGGCCAATGGCCTGGGTTTCCCCCCCTCCACCAATGTCATTGGGCGTGTTTATCTAAACCGTTTTGTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAG	////////////E<//<//E////EA//////<////</////////A//A6/////////////E<///////////AE/////AEA////AEA/6EEEEEE/6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:3	MD:Z:12^G7G0A45	AS:i:49	XS:i:49
NDX550421_RUO:225:HFJ7VBGXL:3:22607:13119:7977	147	4	54732025	60	13S136M	=	54731996	-165	TTTCTCTAAACTCTTTTGTGTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTTCAT	////////EA////<<////<E/A/AEEEAEE//EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:2	MD:Z:19G0A115	AS:i:126	XS:i:45
NDX550421_RUO:225:HFJ7VBGXL:3:12509:24191:12674	99	4	54732030	60	120M29S	=	54732097	216	TGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTTAGAACAGAGCATTTTTGAGCCATTTTTAAAATGCAGAATTTAATTTTTAATTTTGGTAACCAAAAGCAGAGGAAATTTTTTTTATTAATTTTCCAAATGGTGTGTAT	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE6///////////EEEA////A/////EEAEE/<//////A////EEEE//A////</AA<//AEE////////E</AE<//EE//A//6E/E////<//A///////A	NM:i:9	MD:Z:41G15A7A0G14G1C5G2G1G25	AS:i:75	XS:i:37
NDX550421_RUO:225:HFJ7VBGXL:3:22607:14103:13872	163	4	54732030	60	20S77M52S	=	54732030	81	GTTAGAGGGTGTTTTTTGTTTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCATAATAGATGGGAAGGGCGGCGTGTTGGGAAAGAGTGTGCCCAAAACCGTTTT	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE////E///////EEEA////E</<//EE<EA//A/<//<6/////E<A/<///<//<////EA/6A<////////////////<//A/	NM:i:0	MD:Z:77	AS:i:77	XS:i:39
NDX550421_RUO:225:HFJ7VBGXL:2:13212:2679:7162	83	4	54732030	40	99S50M	=	54732006	-74	TTTTATTCACCCCCCACCCGGGCTACGCCGACCTCGCTAATTTGTCGTCTTTTGAGTCGGTGGTCCTTCCCTTAGGCTCCTTATTTTAAAATTCTTTTTTGTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGA	////////////<///</////</////A///</</////E//</////////////A/////////A//A////////////E////EEE////E//////EE//E66EE66666/EE6EEE6AEEE6EEEEEEEEE6EAEAAAA/AA	NM:i:2	MD:Z:14G0A34	AS:i:40	XS:i:47
NDX550421_RUO:225:HFJ7VBGXL:2:23102:2344:17195	83	4	54732030	60	12M4D137M	=	54732037	-146	TGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTCCATGTTCCATCTGCTGTCTCTTTGG	//</EEAEEE<//EAAEEAEAEEAE<A/EAEEEAEEAAEAE</EAE<EEEEEEEEE////EEE/E//<AE<EAEA/EAEE/EEEA66AAEE/A/EE////6E</AE<E<EEAEEEEAAEEE/E//EEEAE/EE/EEAEEEEEEEAAAAA	NM:i:7	MD:Z:6G5^TTGA111T9A15	AS:i:127	XS:i:41
NDX550421_RUO:225:HFJ7VBGXL:3:22607:14103:13872	83	4	54732030	60	68S81M	=	54732030	-81	CCCCCACCGGCCTTGTGCCTGGAGTTCCGACGGGGGCTCATCCCATCTGTTAGCGGGGGTTTTTTGTTTGTTTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAAT	</6/A/////////////E/EA////<///E//A////////E////////////AE/</EEAEE//EE//EAA/6AEEEEE//6EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:0	MD:Z:81	AS:i:81	XS:i:38
NDX550421_RUO:225:HFJ7VBGXL:2:11211:2514:5427	83	4	54732031	40	88S61M	=	54731994	-98	CCCCCCCCGCCGCTTTTTGGTCTGGGGTTTTCCGGGGTGTGCTACGCTTTTTTATGTTTACTTGCGCGTTTCTGTATAAAGTGTTTTGGTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACTGAGCATTTTAGAGC	/////////E/E//A/A////////<////////////E////////////////////////E///////////////////A<//6/A/E//66E/A///E6EE6EEEE6EEEEEAEEEE6EEEEEE/EA///EEE//AEEEAAAAA	NM:i:3	MD:Z:13G0A31A14	AS:i:46	XS:i:44
NDX550421_RUO:225:HFJ7VBGXL:3:11605:14639:5896	83	4	54732031	60	149M	=	54732017	-163	TTTTTTTTTTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTTCATGTTCCAACTGCTGTCTCTT	//EAA//AEEEEE//<AEEEEEEEEEEAEEAEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:3	MD:Z:0G4G8A134	AS:i:138	XS:i:44
NDX550421_RUO:225:HFJ7VBGXL:4:12412:16246:10426	99	4	54732032	60	149M	=	54732079	196	TATTGTTTTTTTTGTTTTTTTATTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTTCATGTTCCAACTGCTGTCTCTTT	AAAAAEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE/E/EE<EAA/<EAEA/AE/EEEEAAAAAEEEEAE//<EEAAAAEEEAE/EEA/EEE/EE6E/EEE//EEEEEEEEAEEAAEEEEEEEAEEAEEE<A/<EA/EE</E/AEA	NM:i:4	MD:Z:1T10G0A7T127	AS:i:132	XS:i:29
NDX550421_RUO:225:HFJ7VBGXL:3:12511:6966:14209	99	4	54732033	60	149M	=	54732107	223	TTTGTTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTAATTTTGAATTTTGGTAACCAAAAGCAGAGGAAATTTTTTTTATTAATGTTCCAAAGGCTGTCTCTTTT	AAAAAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE////E//////EEEEE////A6E///EA<EE////////E///<EEEE/A///////E/AE/EEE///<////<</<E<//EE<////<E/A/6/<<//6///////AEE/	NM:i:10	MD:Z:80C8G1G25A0G3C2C9C0T11G0	AS:i:103	XS:i:38
NDX550421_RUO:225:HFJ7VBGXL:2:23102:2344:17195	163	4	54732037	40	34M115S	=	54732030	146	TTTTTTTGATTTTTTTTTTTTTTTTTTTTTTTTTTTAAAAATGGAATTTTTGAGCCATTTTTAAAATGATAATTGTATTTTTTATTGTTGGTAAAAAAAACAAAGGTATATTTTTTTAATAAAATTACAAAATGAGGTATGTTGGTAGT	AAA/AAEEE//EEEEEEEA<EEEAAEAEAEEEEE///E///////E///A/////////<E</AE<///////E////EEEE</////////AE//EAE////////E//6////6/////////6///<///////////////////	NM:i:0	MD:Z:34	AS:i:34	XS:i:36
NDX550421_RUO:225:HFJ7VBGXL:2:23304:2483:14084	83	4	54732046	60	33S116M	=	54731957	-205	TCTCTAAACTCTTTTGTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTTCATG	//////<<////</</////<E//EEEEEE///EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:0	MD:Z:116	AS:i:116	XS:i:49	SA:Z:12,29405022,+,98S42M9S,0,0;
NDX550421_RUO:225:HFJ7VBGXL:4:13605:22833:2018	147	4	54732049	60	149M	=	54732014	-184	TTTTTTTTTTTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTTCATGTTCCAACTGCTGTCTCTTTGGAATTCCTGTTCTAAT	/<EEEEEEAEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEE/EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:0	MD:Z:149	AS:i:149	XS:i:19
NDX550421_RUO:225:HFJ7VBGXL:1:21301:7377:3373	83	4	54732058	60	149M	=	54731993	-214	TTTTTTTTTTTTTGAGAACAGAGCATTTTAGAGCCATAGTTAAAATGCAGAATGTCATTTTGAAGTGTGGTAACCAAAAGCAGAGGAAATTTAGTTTCTTCATGTTCCAACTGCTGTCTCTTTGGAATTCCTGTTCTAATTTATAAGCT	/AAEEEAEEEEAAEEAEEEEAEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEAAAAA	NM:i:0	MD:Z:149	AS:i:149	XS:i:0""")
        samToBam(self.tmp_sam, self.tmp_aln)
        pysam.index(self.tmp_aln)

    def tearDown(self):
        for curr_file in [self.tmp_aln, self.tmp_aln + ".bai", self.tmp_sam]:
            if os.path.exists(curr_file):
                os.remove(curr_file)

    def test_getMicrosatLengths(self):
        bat_25 = Region(54732046, 54732070, None, "4")
        # Padding 2
        obs_distrib = {}
        with pysam.AlignmentFile(self.tmp_aln, "rb") as aln_reader:
            obs_distrib = getMicrosatLengths(aln_reader, bat_25, padding=2)
        exp_distrib = {
            22: 1,
            23: 1,
            24: 4,
            25: 16,
            26: 3
        }
        self.assertEqual(obs_distrib, exp_distrib)
        # Padding 1
        obs_distrib = {}
        with pysam.AlignmentFile(self.tmp_aln, "rb") as aln_reader:
            obs_distrib = getMicrosatLengths(aln_reader, bat_25, padding=1)
        exp_distrib = {
            22: 1,
            23: 1,
            24: 4,
            25: 17,
            26: 3
        }
        self.assertEqual(obs_distrib, exp_distrib)

    def test_getMicrosatStitchedLengths(self):
        bat_25 = Region(54732046, 54732070, None, "4")
        obs_distrib = {}
        with pysam.AlignmentFile(self.tmp_aln, "rb") as aln_reader:
            obs_distrib = getMicrosatStitchedLengths(aln_reader, bat_25, padding=2)
        exp_distrib = {
            24: 1,
            25: 3
        }
        self.assertEqual(obs_distrib, exp_distrib)


########################################################################
#
# MAIN
#
########################################################################
if __name__ == "__main__":
    unittest.main()
